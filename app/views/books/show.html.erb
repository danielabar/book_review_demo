<div class="max-w-4xl mx-auto px-4 py-8 space-y-10">

  <!-- Back to Book List -->
  <div>
    <%= link_to "← Back to All Books", books_path, class: "inline-block text-indigo-600 hover:text-indigo-800 font-medium transition duration-150" %>
  </div>

  <!-- Book Info -->
  <div id="<%= dom_id(@book) %>" class="bg-white p-6 rounded-lg shadow">
    <h1 class="text-3xl font-bold mb-2"><%= @book.title %></h1>
    <p class="text-gray-700 mb-1"><strong>Author:</strong> <%= @book.author %></p>
    <p class="text-gray-700"><strong>Published Year:</strong> <%= @book.published_year %></p>
  </div>

  <!-- Add/Edit Review or Show User Review -->
  <div class="bg-white p-6 rounded-lg shadow">
    <h2 class="text-2xl font-semibold mb-4"><%= @user_review ? 'Edit Your Review' : 'Add a Review' %></h2>

    <%= form_with(model: [@book, @review], url: @user_review ? book_review_path(@book, @user_review) : book_reviews_path(@book), method: @user_review ? :patch : :post, local: true) do |form| %>
      <% if @review.errors.any? %>
        <div class="mb-4 p-4 bg-red-100 border border-red-300 text-red-700 rounded">
          <h3 class="font-semibold">There were some problems with your submission:</h3>
          <ul class="mt-2 list-disc list-inside">
            <% @review.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="mb-4">
        <%= form.label :body, "Your Review", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.text_area :body, rows: 5, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y" %>
      </div>

      <div class="mb-4">
        <%= form.label :rating, "Rating (1-5)", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :rating, options_for_select(1..5, @review.rating), {}, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" %>
      </div>

      <div class="flex items-center justify-between">
        <%= form.submit @user_review ? "Update Review" : "Submit Review", class: "bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200" %>

        <% if @user_review %>
          <%= form.button "Delete",
              formmethod: :delete,
              formaction: book_review_path(@book, @user_review),
              data: { turbo_confirm: "Are you sure you want to delete your review?" },
              class: "bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Existing Reviews -->
  <div class="bg-white p-6 rounded-lg shadow">
    <h2 class="text-2xl font-semibold mb-4">Reviews</h2>
    <% if @reviews_to_show.any? %>
      <ul class="space-y-6" data-testid="reviews-list">
        <% @reviews_to_show.each do |review| %>
          <li class="border-b pb-4" data-testid="review-item">
            <div class="flex items-center justify-between mb-1">
              <p class="text-gray-700" data-testid="review-author">
                <%= review == @user_review ? 'You' : review.user.email %>
              </p>
              <p class="text-sm text-gray-500 italic">
                <%= time_ago_in_words(review.updated_at) %> ago
              </p>
            </div>
            <div class="flex items-center text-yellow-400 mb-1" data-testid="review-rating">
              <% review.rating.times do %>
                <svg class="w-4 h-4 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.563-.954L10 0l2.947 5.956 6.563.954-4.755 4.635 1.123 6.545z"/></svg>
              <% end %>
            </div>
            <p class="text-gray-700" data-testid="review-body"><%= review.body %></p>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-gray-600 italic">No reviews yet. Be the first to add one!</p>
    <% end %>
  </div>

</div>
